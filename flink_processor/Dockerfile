FROM flink:1.17.2

# å®‰è£… Python3ã€pipã€ç¼–è¯‘å·¥å…·ï¼ˆå®¹å™¨å†…è”ç½‘å®‰è£…ï¼‰
RUN apt-get update && \
    apt-get install -y python3 python3-pip python3-dev build-essential && \
    ln -s /usr/bin/python3 /usr/bin/python

# æ‹·è´æœ¬åœ° wheels åŒ…å’Œ requirements
COPY wheels /opt/flink/wheels
COPY requirements.txt /opt/flink/

# âœ… ä¸‹è½½ Kafka Connector jarï¼ˆç¡®ä¿å…¼å®¹ Flink 1.17.2ï¼‰
RUN wget -O /opt/flink/lib/kafka-clients-2.8.0.jar \
    https://repo1.maven.org/maven2/org/apache/kafka/kafka-clients/2.8.0/kafka-clients-2.8.0.jar
# ä¸‹è½½ flink-connector-kafka-1.17.0.jar
RUN wget -O /opt/flink/lib/flink-connector-kafka-1.17.0.jar \
    https://repo1.maven.org/maven2/org/apache/flink/flink-connector-kafka/1.17.0/flink-connector-kafka-1.17.0.jar

# å®‰è£… Python ä¾èµ–ï¼ˆä½¿ç”¨æœ¬åœ° wheelï¼Œæ— éœ€è”ç½‘ï¼‰
RUN pip3 install --no-index --find-links=/opt/flink/wheels -r /opt/flink/requirements.txt

# è®¾ç½® PYTHONPATHï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
ENV PYTHONPATH=$PYTHONPATH:/opt/flink/lib

# æ‹·è´ä»£ç ç›®å½•å¹¶è®¾ç½®å·¥ä½œè·¯å¾„
WORKDIR /opt/flink/job
COPY . /opt/flink/job/
RUN chmod +x /opt/flink/job/fire_detection.py

# å¯åŠ¨è„šæœ¬ï¼ˆä½¿ç”¨ shell åŒ…è£…ä»¥è®°å½•æ—¥å¿—å’Œå®žçŽ°é‡è¯•ï¼‰

# æ›¿æ¢ CMD ä¸º ENTRYPOINT ä»¥ç¡®ä¿å¯åŠ¨è„šæœ¬ç”Ÿæ•ˆ
ENTRYPOINT ["bash", "-c", "\
echo 'ðŸ“„ å¯åŠ¨ fire_detection.py è„šæœ¬' && \
while true; do \
    python3 /opt/flink/job/fire_detection.py >> /opt/flink/job/fire_detection.log 2>&1; \
    echo 'âš ï¸ è„šæœ¬å¼‚å¸¸é€€å‡ºï¼Œ10ç§’åŽé‡å¯...' >> /opt/flink/job/fire_detection.log; \
    sleep 10; \
done"]